# æ¦‚è§ˆ

## ç®€ä»‹

`@keq-request/cache` æ˜¯ä¸€ä¸ªä¸º Keq è¯·æ±‚åº“æä¾›ç¼“å­˜åŠŸèƒ½çš„ä¸­é—´ä»¶ã€‚å®ƒä¸ºæ— æ³•ä½¿ç”¨ [Service Worker](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API) çš„é¡¹ç›®æä¾›äº†ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„ç¼“å­˜è§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **é›¶é…ç½®å¯åŠ¨** - å¼€ç®±å³ç”¨çš„ç¼“å­˜åŠŸèƒ½
- ğŸ¯ **å¤šç§ç¼“å­˜ç­–ç•¥** - æ”¯æŒç½‘ç»œä¼˜å…ˆã€ç¼“å­˜ä¼˜å…ˆã€ä»…ç½‘ç»œç­‰å¤šç§ç­–ç•¥
- ğŸ’¾ **çµæ´»çš„å­˜å‚¨æ–¹æ¡ˆ** - æ”¯æŒå†…å­˜ã€IndexedDB ä»¥åŠå¤šå±‚ç¼“å­˜
- ğŸ¨ **è§„åˆ™åŒ–é…ç½®** - é€šè¿‡è§„åˆ™çµæ´»æ§åˆ¶ä¸åŒè¯·æ±‚çš„ç¼“å­˜è¡Œä¸º
- ğŸ”§ **å¯æ‰©å±•** - æ”¯æŒè‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥å’Œå­˜å‚¨å®ç°

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```typescript
import { request } from "keq"
import { cache, MemoryStorage } from "@keq-request/cache"

// åˆ›å»ºå­˜å‚¨å®ä¾‹
const storage = new MemoryStorage()

// ä½¿ç”¨ç¼“å­˜ä¸­é—´ä»¶
// é»˜è®¤ä¸ä¼šç¼“å­˜ä»»ä½•è¯·æ±‚
request.use(cache({ storage }))

// å‘èµ·è¯·æ±‚
request
  .get("/api/data")
  // å¯ç”¨ç¼“å­˜
  .option('cache', {
    key: '/api/data',
    strategy: Strategy.CACHE_FIRST,
    ttl: 60, // ç¼“å­˜ 60 ç§’
  })
```


### é…ç½®ç¼“å­˜è§„åˆ™

```typescript
import { request } from "keq"
import { cache, Strategy, MemoryStorage } from "@keq-request/cache"

request.use(
  cache({
    storage: new MemoryStorage(),
    rules: [
      {
        // åŒ¹é…æ‰€æœ‰ GET è¯·æ±‚
        pattern: (ctx) => ctx.request.method === "get",

        // ä½¿ç”¨ SWR ç­–ç•¥
        strategy: Strategy.STALE_WHILE_REVALIDATE,

        // ç¼“å­˜æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿ
        ttl: 5 * 60,

        // è‡ªå®šä¹‰ç¼“å­˜é”®
        key: (ctx) => ctx.request.__url__.href,

        // æ’é™¤é 200 å“åº”
        exclude: async (response) => response.status !== 200,
      },
    ],
  })
)
```

### è¯·æ±‚çº§åˆ«é…ç½®

å¯ä»¥åœ¨å‘èµ·è¯·æ±‚æ—¶è¦†ç›–å…¨å±€é…ç½®ï¼š

```typescript
import { request } from "keq"
import { Strategy } from "@keq-request/cache"

request
  .get("/cats")
  // è¦†ç›–å…¨å±€ç¼“å­˜é…ç½®
  .options({
    cache: {
      strategy: Strategy.NETWORK_FIRST,
      key: 'custom-cache-key',
      // æœªè®¾ç½®çš„å±æ€§å°†ä½¿ç”¨å…¨å±€é…ç½®
      // exclude: async (response) => response.status !== 200,
      ttl: 60,
    },
  })

  // ä¹Ÿå¯ä»¥ç¦æ­¢ç¼“å­˜
  .option('cache', false)
```

## é…ç½®é¡¹

| å‚æ•°å                   | ç±»å‹                                                | é»˜è®¤å€¼                                              | è¯´æ˜                                                        |
| :---------------------- | :------------------------------------------------- | :------------------------------------------------- | :------------------------------------------------------------- |
| storage                 | `KeqCacheStorage`                                  | -                                                  | ç¼“å­˜å­˜å‚¨å®ä¾‹ï¼Œ[è¯¦è§ Storage](./storage)                        |
| keyFactory              | `(context) => string`                              | `(context) => context.locationId`                  | ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°ï¼Œç”Ÿæˆç›¸åŒ key çš„è¯·æ±‚å°†å…±äº«ç¼“å­˜                  |
| serverTiming            | `boolean`                                          | `false`                                            | æ˜¯å¦åœ¨å“åº”å¤´ä¸­æ·»åŠ  `Server-Timing`                             |
| rules                   | `Rule[]`                                           | `[]`                                               | ç¼“å­˜è§„åˆ™æ•°ç»„                                                   |

**rules**

| å‚æ•°å                   | ç±»å‹                                                | é»˜è®¤å€¼                                           | è¯´æ˜                                                           |
| :---------------------- | :------------------------------------------------- | :------------------------------------------------- | :------------------------------------------------------------- |
| pattern                 | `boolean \| (ctx) => boolean`                      | `true`                                             | åŒ¹é…è§„åˆ™ï¼Œç”¨äºåˆ¤æ–­è¯·æ±‚æ˜¯å¦åº”ç”¨æ­¤ç¼“å­˜è§„åˆ™                       |
| key                     | `(ctx) => string`                                  | ä½¿ç”¨å…¨å±€ `keyFactory`                              | è‡ªå®šä¹‰ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°                                           |
| strategy                | `Strategy`                                         | `Strategy.NETWORK_FIRST`                           | ç¼“å­˜ç­–ç•¥ï¼Œ[è¯¦è§ ç¼“å­˜ç­–ç•¥](./strategies)                        |
| ttl                     | `number`                                           | `Infinity`                                         | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰                                               |
| exclude                 | `(response) => boolean \| Promise<boolean>`        | -                                                  | æ’é™¤å‡½æ•°ï¼Œè¿”å› `true` æ—¶ä¸ç¼“å­˜è¯¥å“åº”                           |
| serverTiming            | `boolean`                                          | `false`                                            | æ˜¯å¦åœ¨å“åº”å¤´ä¸­æ·»åŠ  `Server-Timing`                             |

## æ‰©å±•é¡¹

### `.on(eventName, callback)`

| äº‹ä»¶å       | è¯´æ˜                           | å›è°ƒå‚æ•°                                      |
| :----------- | :----------------------------- | :------------------------------------------ |
| cache:hit    | ç¼“å­˜å‘½ä¸­æ—¶è§¦å‘                 | `({ key: string, response: Response, context: KeqContext })`
| cache:miss   | ç¼“å­˜æœªå‘½ä¸­æ—¶è§¦å‘               | `({ key: string, context: KeqContext})`                  |
| cache:update | ç¼“å­˜æ›´æ–°æ—¶è§¦å‘                 | `({ key: string, oldResponse: Response, newResponse: Response, context: KeqContext })`            |

### `.option('cache', options)`

| å‚æ•°å            | ç±»å‹                                               | è¯´æ˜                                                           |
| :---------------- | :------------------------------------------------- | :------------------------------------------------------------- |
| key               | `(ctx) => string`                                  | è‡ªå®šä¹‰ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°                                           |
| debug             | `boolean`                                          | æ‰“å°è°ƒè¯•æ—¥å¿—                                                   |
| strategy          | `Strategy`                                         | ç¼“å­˜ç­–ç•¥ï¼Œ[è¯¦è§ ç¼“å­˜ç­–ç•¥](./strategies)                        |
| ttl               | `number`                                           | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰                                               |
| exclude           | `(response) => boolean \| Promise<boolean>`        | æ’é™¤å‡½æ•°ï¼Œè¿”å› `true` æ—¶ä¸ç¼“å­˜è¯¥å“åº”                           |
| serverTiming      | `boolean`                                          | æ˜¯å¦åœ¨å“åº”å¤´ä¸­æ·»åŠ  `Server-Timing`                             |
